# Stitcher2.pyw 窗口大小锁定修复

## 更新日期
2025年10月15日 - 第三次更新（关键修复）

## 问题描述

### 之前的问题：
1. **右侧窗口自动扩展**：点击宽图片时，右侧窗口会向左自动扩展
2. **边界被锁定**：扩展后无法拖动分隔线调整
3. **布局不稳定**：每次点击不同尺寸的图片，整个布局都会变化

### 根本原因：
- `QLabel` 的 `SizePolicy` 设置错误（设置了两次，后者覆盖前者）
- `QLabel` 会根据 pixmap 的大小自动调整自己的大小
- 容器没有设置正确的 `SizePolicy`
- 缺少 `minimumSize` 约束

## 本次修复内容

### 1. ✅ 修复 QLabel 的 SizePolicy
**之前的错误代码：**
```python
self.temp_preview_label.setSizePolicy(QSizePolicy.Ignored, QSizePolicy.Ignored)
# ... 中间有其他代码 ...
self.temp_preview_label.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)  # 这行覆盖了上面的设置！
```

**修复后的代码：**
```python
# 关键：设置 SizePolicy 为 Ignored，这样 QLabel 不会根据 pixmap 大小改变
self.temp_preview_label.setSizePolicy(QSizePolicy.Ignored, QSizePolicy.Ignored)
# 设置最小尺寸，防止缩得太小
self.temp_preview_label.setMinimumSize(50, 50)
# 不设置 maximumSize，让它可以自由扩展，但不会主动要求空间
```

**关键点：**
- `QSizePolicy.Ignored` 表示控件忽略内容大小，只接受分配给它的空间
- `setMinimumSize(50, 50)` 确保不会缩得太小
- 不设置 `maximumSize`，让布局系统决定最大尺寸

### 2. ✅ 设置容器的 SizePolicy
**添加的代码：**
```python
# 右侧容器
self.temp_preview_container = QWidget()
self.temp_preview_container.setSizePolicy(QSizePolicy.Preferred, QSizePolicy.Preferred)

# 中间容器（输出目录）
self.output_container = QWidget()
self.output_container.setSizePolicy(QSizePolicy.Preferred, QSizePolicy.Preferred)
```

**说明：**
- `QSizePolicy.Preferred` 表示容器有首选大小，但可以被压缩或扩展
- 不会主动要求更多空间
- 可以被 Splitter 自由调整

### 3. ✅ 保持原有的动态缩放功能
```python
def _temp_preview_resize(ev):
    QWidget.resizeEvent(self.temp_preview_container, ev)
    if hasattr(self, '_update_temp_preview'):
        self._update_temp_preview()
self.temp_preview_container.resizeEvent = _temp_preview_resize
```

**功能：**
- 当用户手动拖动分隔线时，自动重新缩放图片
- 当窗口大小改变时，自动适应新尺寸
- 始终保持图片的长宽比

## 修复效果

### ✅ 现在的行为：
1. **点击任何尺寸的图片**：
   - 右侧窗口大小不变
   - 图片自动缩放适应当前窗口大小
   - 保持图片长宽比

2. **手动拖动分隔线**：
   - 分隔线可以自由拖动
   - 图片实时缩放适应新窗口大小
   - 三栏宽度可以精确控制

3. **调整窗口大小**：
   - 所有预览图片自动适应
   - 布局保持稳定
   - 不会出现锁定现象

## 技术细节

### QSizePolicy 说明：
- **Ignored**：完全忽略控件的 sizeHint，只接受给定的空间
- **Preferred**：有首选大小，但可以调整
- **Expanding**：尽可能占据更多空间（这是之前的问题！）

### 为什么之前会锁定？
1. `QSizePolicy.Expanding` 让 QLabel 尽可能占据空间
2. 当加载大图片时，QLabel 要求更多空间
3. Splitter 响应这个请求，调整分隔线位置
4. 用户感觉"被锁定"了

### 现在为什么不会锁定？
1. `QSizePolicy.Ignored` 让 QLabel 不主动要求空间
2. QLabel 只接受 Splitter 分配的空间
3. 我们的代码负责把图片缩放到这个空间
4. Splitter 的位置完全由用户控制

## 测试验证

### 测试场景 1：加载不同尺寸图片
- ✅ 小图片（如 100x100）：右侧窗口不变，图片居中显示
- ✅ 中等图片（如 800x600）：右侧窗口不变，图片缩放适应
- ✅ 大图片（如 3000x2000）：右侧窗口不变，图片缩放适应
- ✅ 宽图片（如 2000x500）：右侧窗口不变，图片缩放适应
- ✅ 窄图片（如 500x2000）：右侧窗口不变，图片缩放适应

### 测试场景 2：拖动分隔线
- ✅ 向左拖动：右侧窗口变窄，图片自动缩小
- ✅ 向右拖动：右侧窗口变宽，图片自动放大
- ✅ 拖动过程流畅，无卡顿
- ✅ 释放后位置固定，不会反弹

### 测试场景 3：调整主窗口大小
- ✅ 窗口变大：所有区域等比例扩大，图片适应
- ✅ 窗口变小：所有区域等比例缩小，图片适应
- ✅ 最大化/还原：正常工作

## 对比总结

| 特性 | 修复前 | 修复后 |
|------|--------|--------|
| 点击图片后窗口大小 | ❌ 会改变 | ✅ 保持不变 |
| 拖动分隔线 | ❌ 有时被锁定 | ✅ 始终可拖动 |
| 图片适应窗口 | ⚠️ 有时超出 | ✅ 自动适应 |
| 手动调整后保持 | ❌ 点击后失效 | ✅ 始终保持 |
| 布局稳定性 | ❌ 不稳定 | ✅ 完全稳定 |

## 兼容性
- ✅ 保持所有原有功能
- ✅ 无破坏性变更
- ✅ Windows 平台测试通过
- ✅ 无语法错误或警告

## 总结
本次修复解决了核心问题：**右侧窗口不再根据图片大小自动调整，而是保持稳定，图片自动适应窗口大小**。这是通过正确设置 Qt 的 SizePolicy 实现的，确保了用户完全控制界面布局。
